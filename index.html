<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2학년 호기심 연구소 동아리 탐구 설문</title>
  <style>
    body { font-family: sans-serif; line-height: 1.6; margin: 20px; }
    .page { display: none; }
    .page.active { display: block; }
    .question { margin: 15px 0; }
    .question label { display: block; margin: 5px 0; font-size: 1.2em; }
    .timer { font-weight: bold; color: red; font-size: 1.2em; }
    .nav-buttons { margin-top: 30px; }
    button { padding: 10px 20px; font-size: 1.2em; }
    input[type="text"] { font-size: 1.1em; width: 100%; padding: 6px; }
    img { display: block; margin: 10px 0; max-width: 100%; height: auto; }
    #resultPage { display: none; margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const TIME_LIMIT = 10;
    let currentPage = 1;
    let timerId = null;
    let timeLeft = TIME_LIMIT;

    const SUPABASE_URL = 'https://jmcyiaxgdtyliokxiobi.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_ETsX2-0BgAmgUoM1WRYuaw_EqOGAAF7';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.goNextPage = function (pageNum) {
      if (!validatePage(pageNum)) return;
      clearTimeout(timerId);
      const nextPageNum = pageNum + 1;
      if (nextPageNum > 4) return;
      currentPage = nextPageNum;
      showPage(currentPage);
      if (currentPage === 2 || currentPage === 3) startTimer(currentPage);
    };

    window.submitForm = async function () {
      if (!validatePage(4)) return;

      const response = {
        respondent_name: getValue('grade'),
        question1_answer: getValue('knowEuler'),
        question2_answer: getValue('readGuide'),
        image_choice: getValue('imageChoice'),
        difficulty: getValue('difficulty'),
        feedback: getValue('feedback', false),
        overall: getValue('overallDifficulty')
      };

      const { error } = await supabase.from('survey_results').insert([response]);
      if (error) {
        alert('저장 중 오류 발생: ' + error.message);
        return;
      }

      document.getElementById('formWrapper').style.display = 'none';
      document.getElementById('submitMsg').style.display = 'block';
    };

    function showPage(pageNum) {
      document.querySelectorAll('.page').forEach(div => div.classList.remove('active'));
      const pageDiv = document.getElementById('page' + pageNum);
      if (pageDiv) pageDiv.classList.add('active');
    }

    function validatePage(pageNum) {
      const pageDiv = document.getElementById('page' + pageNum);
      if (!pageDiv) return true;
      const requiredInputs = pageDiv.querySelectorAll('input[required]');
      for (let input of requiredInputs) {
        if (input.type === 'radio') {
          const name = input.name;
          const checked = pageDiv.querySelector(`input[name="${name}"]:checked`);
          if (!checked) {
            alert("모든 문항에 답변해주세요.");
            return false;
          }
        } else if (!input.value.trim()) {
          alert("모든 문항에 답변해주세요.");
          return false;
        }
      }
      return true;
    }

    function startTimer(pageNum) {
      timeLeft = TIME_LIMIT;
      const timerElem = document.getElementById('timer' + pageNum);
      if (!timerElem) return;
      timerElem.textContent = `(${timeLeft}초 남음)`;
      timerId = setInterval(() => {
        timeLeft--;
        timerElem.textContent = `(${timeLeft}초 남음)`;
        if (timeLeft <= 0) {
          clearInterval(timerId);
          alert("제한 시간이 초과되어 응답이 중단됩니다.");
          window.close();
        }
      }, 1000);
    }

    function getValue(name, isRadio = true) {
      if (isRadio) {
        const input = document.querySelector(`input[name="${name}"]:checked`);
        return input ? input.value : '';
      } else {
        const input = document.querySelector(`input[name="${name}"]`);
        return input ? input.value : '';
      }
    }

    document.addEventListener('keydown', async function(event) {
      if (event.key === '8') {
        const resultDiv = document.getElementById('resultPage');
        const tbody = document.querySelector('#responseTable tbody');
        tbody.innerHTML = '';

        const { data, error } = await supabase.from('survey_results').select('*');
        if (error) {
          alert('결과 불러오기 오류: ' + error.message);
          return;
        }

        data.forEach(entry => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${entry.submitted_at || ''}</td><td>${entry.respondent_name}</td><td>${entry.question1_answer}</td><td>${entry.question2_answer}</td><td>${entry.image_choice}</td><td>${entry.difficulty}</td><td>${entry.feedback}</td><td>${entry.overall}</td>`;
          tbody.appendChild(tr);
        });

        resultDiv.style.display = 'block';
        document.getElementById('submitMsg').style.display = 'none';
      }
    });
  </script>
</head>
<body>
  <div id="formWrapper">
    <!-- 페이지 구성 및 질문 섹션 삽입 -->
  </div>
  <div id="submitMsg" style="margin-top:15px; color: blue; font-size: 1.5em; display: none;">
    설문 응답이 제출되었습니다. 참여해주셔서 감사합니다!
  </div>
  <div id="resultPage">
    <h2>응답 결과</h2>
    <table id="responseTable">
      <thead>
        <tr>
          <th>시간</th>
          <th>학년</th>
          <th>한붓그리기 인지</th>
          <th>안내 이해</th>
          <th>이미지 선택</th>
          <th>난이도 비교</th>
          <th>소감</th>
          <th>한붓 시도</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>
